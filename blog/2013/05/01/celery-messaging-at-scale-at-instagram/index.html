
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Celery messaging at scale at Instagram - thoughts in plain text</title>
  <meta name="author" content="Sergii Khomenko">

  
  <meta name="description" content="Interesting talk by an infrastructure engineer from Instagram.
Described idea of feed generation at scale from different points of view, starting &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lc0.github.io/blog/2013/05/01/celery-messaging-at-scale-at-instagram/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="thoughts in plain text" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17027178-8']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">thoughts in plain text</a></h1>
  
    <h2>my thoughts about data science, software engineering and startups</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lc0.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Celery Messaging at Scale at Instagram</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-01T15:27:00+02:00" pubdate  data-updated="true">May 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Interesting talk by an infrastructure engineer from Instagram.
Described idea of feed generation at scale from different points of view, starting with simple and very expensive O(∞),
after with Gearman &amp; Python solutions and finally based on Celery and RabbitMQ. Considered different brokers to have reasonably fast time of response from one point
and also good replication and even chunking from another. Good overview of configuring Celery for big scale with different routings, queues and concurrency levels.</p>

<script async="true" class="speakerdeck-embed" data-ratio="1.7" data-id="057d90a07156013098d412313918245d" src="//speakerdeck.com/assets/embed.js"> </script>

<!--more-->

<p>And the video of the talk by Rick Branson, Infrastructure Engineer at Instagram</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/E708csv4XgY"></iframe></div>

<h3 id="outline">Outline</h3>

<h4 id="i-concepts">I. Concepts</h4>
<ul>
  <li>A Brief History of Messaging and Queues</li>
  <li>The 3 Messaging Topologies</li>
  <li>Messaging Pattern: Request-Reply (RPC)</li>
  <li>Messaging Pattern: Publish/Subscribe</li>
  <li>Messaging Pattern: Push-Pull (Workers)</li>
  <li>Why use a message broker anyway?</li>
</ul>

<h4 id="ii-workers-at-instagram">II. Workers at Instagram</h4>
<ul>
  <li>Use Case #1: Feed Delivery</li>
  <li>Other Use Cases</li>
  <li>Then: Gearman</li>
  <li>Gearman in Python: Coding &amp; Testing</li>
  <li>Gearman in Production: Monitoring &amp; what goes wrong?</li>
  <li>Now: RabbitMQ &amp; Celery</li>
  <li>Celery in Python: Coding &amp; Testing</li>
  <li>RabbitMQ in Production: Monitoring, Availability, Scaling, Fault Tolerance, and What Goes Wrong</li>
  <li>Our Hacks on Celery</li>
  <li>Message Flow, Priority, and QoS</li>
  <li>Fault Tolerance: Retries and Crash Safety</li>
  <li>Concurrency &amp; The Dark Magic of Evented Workers</li>
</ul>

<h4 id="iii-alternatives">III. Alternatives</h4>
<ul>
  <li>Not Everything is Crucial</li>
  <li>Engineering Trade-Offs: Cost &amp; Performance vs Correctness</li>
  <li>The Hail-Mary: UDP &amp; Python, Use Cases</li>
  <li>The Event Bus</li>
  <li>Real-Time Web Delivery</li>
  <li>Why not use …?</li>
</ul>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sergii Khomenko</span></span>

      








  


<time datetime="2013-05-01T15:27:00+02:00" pubdate  data-updated="true">May 1<span>st</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/celery/'>celery</a>, <a class='category' href='/blog/categories/pycon2013/'>pycon2013</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/rabbithq/'>rabbithq</a>, <a class='category' href='/blog/categories/scaling/'>scaling</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://lc0.github.io/blog/2013/05/01/celery-messaging-at-scale-at-instagram/" data-via="lc0d3r" data-counturl="http://lc0.github.io/blog/2013/05/01/celery-messaging-at-scale-at-instagram/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/09/actionable-customer-development/" title="Previous Post: Actionable customer development">&laquo; Actionable customer development</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/06/08/steal-like-an-artist-10-things-nobody-told-you-about-being-creative/" title="Next Post: Steal Like an Artist: 10 Things Nobody Told You About Being Creative">Steal Like an Artist: 10 Things Nobody Told You About Being Creative &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/14/data-driven-approach-to-cfp-mining-pydata-conferences/">Data-driven approach to CFP - mining PyData conferences</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/01/scientific-octopress-writing-latex-formulas-and-r-code/">Scientific Octopress: Writing LaTeX formulas and R code</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/21/the-story-of-your-data-by-r/">The story of your data by R</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/25/twitter-word-cloud-with-r/">Twitter word cloud with R</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/26/building-and-scaling-a-company-linkedin-story/">Building and scaling a company. Linkedin story.</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/500s' style='font-size: 112.0%'>500s(1)</a> <a href='/blog/categories/architecture-review' style='font-size: 124.0%'>architecture-review(2)</a> <a href='/blog/categories/books' style='font-size: 112.0%'>books(1)</a> <a href='/blog/categories/celery' style='font-size: 112.0%'>celery(1)</a> <a href='/blog/categories/cfp' style='font-size: 112.0%'>CFP(1)</a> <a href='/blog/categories/creativity' style='font-size: 112.0%'>creativity(1)</a> <a href='/blog/categories/customer-development' style='font-size: 112.0%'>customer development(1)</a> <a href='/blog/categories/data-mining' style='font-size: 124.0%'>data mining(2)</a> <a href='/blog/categories/data-driven' style='font-size: 112.0%'>data-driven(1)</a> <a href='/blog/categories/dave-mcclure' style='font-size: 112.0%'>Dave McClure(1)</a> <a href='/blog/categories/idcee' style='font-size: 112.0%'>idcee(1)</a> <a href='/blog/categories/imagehack' style='font-size: 112.0%'>imagehack(1)</a> <a href='/blog/categories/ipython' style='font-size: 112.0%'>ipython(1)</a> <a href='/blog/categories/latex' style='font-size: 112.0%'>LaTeX(1)</a> <a href='/blog/categories/lean' style='font-size: 112.0%'>lean(1)</a> <a href='/blog/categories/life' style='font-size: 112.0%'>life(1)</a> <a href='/blog/categories/mathjs' style='font-size: 112.0%'>MathJs(1)</a> <a href='/blog/categories/matplotlib' style='font-size: 112.0%'>matplotlib(1)</a> <a href='/blog/categories/networking' style='font-size: 112.0%'>networking(1)</a> <a href='/blog/categories/nltk' style='font-size: 112.0%'>nltk(1)</a> <a href='/blog/categories/octopress' style='font-size: 112.0%'>Octopress(1)</a> <a href='/blog/categories/octopress' style='font-size: 112.0%'>octopress(1)</a> <a href='/blog/categories/pandas' style='font-size: 112.0%'>pandas(1)</a> <a href='/blog/categories/people' style='font-size: 112.0%'>people(1)</a> <a href='/blog/categories/product-design' style='font-size: 112.0%'>product design(1)</a> <a href='/blog/categories/pycon2013' style='font-size: 112.0%'>pycon2013(1)</a> <a href='/blog/categories/pydata' style='font-size: 112.0%'>pydata(1)</a> <a href='/blog/categories/python' style='font-size: 112.0%'>python(1)</a> <a href='/blog/categories/quotes' style='font-size: 112.0%'>quotes(1)</a> <a href='/blog/categories/r' style='font-size: 124.0%'>R(2)</a> <a href='/blog/categories/rabbithq' style='font-size: 112.0%'>rabbithq(1)</a> <a href='/blog/categories/recommender-systems' style='font-size: 112.0%'>recommender systems(1)</a> <a href='/blog/categories/scaling' style='font-size: 136.0%'>scaling(3)</a> <a href='/blog/categories/science' style='font-size: 112.0%'>science(1)</a> <a href='/blog/categories/startups' style='font-size: 112.0%'>Startups(1)</a> <a href='/blog/categories/startups' style='font-size: 160.0%'>startups(5)</a> <a href='/blog/categories/stylight' style='font-size: 124.0%'>Stylight(2)</a> <a href='/blog/categories/test' style='font-size: 112.0%'>test(1)</a> <a href='/blog/categories/tutorials' style='font-size: 112.0%'>tutorials(1)</a> <a href='/blog/categories/usability' style='font-size: 112.0%'>usability(1)</a> </span>
</section>
<section>
  <h1>Latest Tweets</h1>
  <a class="twitter-timeline" href="https://twitter.com/lc0d3r" data-widget-id="366606430293356544">Tweets by @lc0d3r</a>
  <script>$.domReady(function(){
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    });
  </script>

</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/lc0">@lc0</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'lc0',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/111752859687225196264?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Sergii Khomenko -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lc0git';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://lc0.github.io/blog/2013/05/01/celery-messaging-at-scale-at-instagram/';
        var disqus_url = 'http://lc0.github.io/blog/2013/05/01/celery-messaging-at-scale-at-instagram/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/SVG"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
</body>
</html>
